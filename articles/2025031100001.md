---
title: "Googleã®ç›£æŸ»ãƒ­ã‚°ã§å¤–éƒ¨å…±æœ‰æ“ä½œã‚’ç›£è¦–ã—ãŸã„ï¼ˆä¸‹æº–å‚™ï¼‰"
emoji: "ğŸ¦†"
type: "idea"
topics:
  - "GoogleWorkspace"
published: true
published_at: "2025-03-11 20:00"
---

# ãªãœä½œæˆã—ãŸã®ã‹
- ã„ã„åŠ æ¸›è¦‹ãªã„ãµã‚Šã‚’ã—ã¦ããŸGoogleãƒ‰ãƒ©ã‚¤ãƒ–ã®å¤–éƒ¨å…±æœ‰ã‚’å¯è¦–åŒ–ã—ã¦ã„ããŸã„

# å½“é¢ã®ç›®æ¨™
- Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®ç›£æŸ»ãƒ­ã‚°ã§å¤–éƒ¨å…±æœ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸€æ—¥ã”ã¨ã«é›†è¨ˆã—ã€ãã®æ—¥ã«çµ„ç¹”ã§å¤–éƒ¨å…±æœ‰ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã€å®Ÿæ–½è€…ã‚’å¯è¦–åŒ–ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„

ä»¥ä¸‹ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

- **ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ** ã§å®Ÿè¡Œã—ã€å¯¾è±¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç›£æŸ»ãƒ­ã‚°ã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ãŒå¿…è¦ã§ã™ã€‚  
- ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§ã¯ã€**Admin SDK ãƒ¬ãƒãƒ¼ãƒˆã®æ‹¡å¼µã‚µãƒ¼ãƒ“ã‚¹**ï¼ˆAdminReportsï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã®ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€Œã‚µãƒ¼ãƒ“ã‚¹ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒAdmin SDKã€ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚  
- æŒ‡å®šã—ãŸæœŸé–“ï¼ˆä¾‹ï¼šå‰æ—¥ï½å½“æ—¥ï¼‰ã®é–“ã«ç™ºç”Ÿã—ãŸ Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®å…±æœ‰å¤‰æ›´ï¼ˆå¤–éƒ¨å…±æœ‰ï¼‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã¾ã¨ã‚ã‚‹ä¾‹ã§ã™ã€‚  
- å®Ÿè¡Œå¾Œã€ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¦**æ¯æ—¥è‡ªå‹•å®Ÿè¡Œ**ã•ã›ã‚‹ã“ã¨ã§ã€æ—¥æ¬¡é›†è¨ˆã®é‹ç”¨ãŒå¯èƒ½ã§ã™ï¼ˆApps Scriptã®ç·¨é›†ç”»é¢ â†’ æ™‚è¨ˆã‚¢ã‚¤ã‚³ãƒ³ã€Œãƒˆãƒªã‚¬ãƒ¼ã€ã‹ã‚‰è¨­å®šï¼‰ã€‚  

```javascript
/**************************************
 * å¤–éƒ¨å…±æœ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ—¥æ¬¡é›†è¨ˆã—ã€
 * å¯¾è±¡ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãå‡ºã™ä¾‹
 * ï¼ˆå…±æœ‰å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–åä»˜ãï¼‰
 **************************************/

function exportDailyExternalSharingLog() {
  // --- â‘ å–å¾—æœŸé–“ã‚’è¨­å®šï¼ˆå‰æ—¥0æ™‚ï½å½“æ—¥0æ™‚ãªã©ã«èª¿æ•´ï¼‰---
  // ã“ã“ã§ã¯ä¾‹ã¨ã—ã¦ã€Œå‰æ—¥ã®00:00:00 ã€œ ä»Šæ—¥ã®00:00:00ã€
  var today = new Date();
  var start = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 1, 0, 0, 0);
  var end   = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0);

  // ãƒ¬ãƒãƒ¼ãƒˆAPIç”¨ã®æ™‚é–“å½¢å¼ã«å¤‰æ› (ISO8601: yyyy-MM-ddTHH:mm:ssZ)
  var startTime = Utilities.formatDate(start, "UTC", "yyyy-MM-dd'T'HH:mm:ss'Z'");
  var endTime   = Utilities.formatDate(end,   "UTC", "yyyy-MM-dd'T'HH:mm:ss'Z'");

  // --- â‘¡Admin SDK ãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰Driveãƒ­ã‚°ã‚’å–å¾— ---
  var activities = [];
  var pageToken;
  do {
    var response = AdminReports.Activities.list("all", "drive", {
      startTime: startTime,
      endTime: endTime,
      pageToken: pageToken
    });
    if (response.items && response.items.length > 0) {
      activities = activities.concat(response.items);
    }
    pageToken = response.nextPageToken;
  } while (pageToken);

  // --- â‘¢å¤–éƒ¨å…±æœ‰ã‚¤ãƒ™ãƒ³ãƒˆã¨æ€ã—ãã‚‚ã®ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ---
  // "acl_change" or "change_user_access" ã‚¤ãƒ™ãƒ³ãƒˆ ã‹ã¤ newValue = "outsideDomain" ã‚’å¯¾è±¡
  var externalSharingActivities = activities.filter(function(activity) {
    if (!activity.events) return false;
    return activity.events.some(function(evt) {
      if (evt.name !== "acl_change" && evt.name !== "change_user_access") return false;
      // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸­ã« newValue: "outsideDomain" ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      var hasOutsideParam = (evt.parameters || []).some(function(param) {
        return param.name === "newValue" && param.value === "outsideDomain";
      });
      return hasOutsideParam;
    });
  });

  // --- â‘£çµæœã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãå‡ºã™ ---
  // ä¾‹ã¨ã—ã¦ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç´ã¥ã„ãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã€ŒYYYY-MM-DD_å¤–éƒ¨å…±æœ‰ã€ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦æ›¸ãè¾¼ã¿
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetName = Utilities.formatDate(start, "Asia/Tokyo", "yyyy-MM-dd") + "_å¤–éƒ¨å…±æœ‰";
  var sheet = ss.getSheetByName(sheetName) || ss.insertSheet(sheetName);
  sheet.clearContents();

  // è¦‹å‡ºã—è¡Œ
  var headers = [
    "ã‚¤ãƒ™ãƒ³ãƒˆæ—¥æ™‚ (UTC)",
    "å®Ÿæ–½è€…ï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‰",
    "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«",
    "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID",
    "ã‚¤ãƒ™ãƒ³ãƒˆå",
    "newValue",
    "oldValue",
    "å…±æœ‰å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹",
    "å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–å"
  ];
  sheet.appendRow(headers);

  externalSharingActivities.forEach(function(activity) {
    var actorEmail = activity.actor.email || "";
    var eventTime  = activity.id.time; // ISO8601å½¢å¼ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—

    (activity.events || []).forEach(function(evt) {
      // å¤–éƒ¨å…±æœ‰ã«è©²å½“ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¢ã™
      var docTitle = "";
      var docId = "";
      var newValue = "";
      var oldValue = "";

      // è¿½åŠ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
      var targetUser = "";     // å…±æœ‰å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
      var driveName = "";      // å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–åï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰

      (evt.parameters || []).forEach(function(param) {
        switch (param.name) {
          case "doc_title":
            docTitle = param.value;
            break;
          case "doc_id":
            docId = param.value;
            break;
          case "newValue":
            newValue = param.value;
            break;
          case "oldValue":
            oldValue = param.value;
            break;
          case "target_user":
            // å…±æœ‰å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            // param.value ã«å…±æœ‰å…ˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆãŒå¤šã„
            targetUser = param.value;
            break;
          case "drive_name":
            // å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–åï¼ˆå…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã«å«ã¾ã‚Œã‚‹ï¼‰
            driveName = param.value;
            break;
          default:
            // ä»–ã«å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¿½åŠ 
            break;
        }
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ãªã®ã§ newValue: outsideDomain ã‚’å«ã‚€ã‚‚ã®ã‚’ã“ã“ã§å‡ºåŠ›
      if (newValue === "outsideDomain") {
        sheet.appendRow([
          eventTime,
          actorEmail,
          docTitle,
          docId,
          evt.name,
          newValue,
          oldValue,
          targetUser,
          driveName
        ]);
      }
    });
  });

  Logger.log("å‡¦ç†ãŒå®Œäº†ã—ã€" + sheetName + " ã‚·ãƒ¼ãƒˆã« " + externalSharingActivities.length + " ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚");
}
```

---

### ã‚³ãƒ¼ãƒ‰ã®æ¦‚è¦

1. **æ—¥ä»˜ã®è¨­å®š**  
   - å‰æ—¥ã®0æ™‚ã‹ã‚‰å½“æ—¥ã®0æ™‚ã¾ã§ã®é–“ã«è¡Œã‚ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’å¯¾è±¡ã¨ã—ã¦ã„ã¾ã™ã€‚  
   - `startTime` ã¨ `endTime` ã‚’ ISO8601å½¢å¼ (`yyyy-MM-dd'T'HH:mm:ss'Z'`) ã«å¤‰æ›ã€‚

2. **ãƒ¬ãƒãƒ¼ãƒˆAPIå‘¼ã³å‡ºã—**  
   - `AdminReports.Activities.list("all", "drive", {...})` ã§ãƒ‰ãƒ©ã‚¤ãƒ–ã®ç›£æŸ»ãƒ­ã‚°ã‚’å–å¾—ã—ã¾ã™ã€‚  
   - `pageToken` ã‚’åˆ©ç”¨ã—ã¦ç¹°ã‚Šè¿”ã—å‘¼ã³å‡ºã—ã€å…¨ãƒšãƒ¼ã‚¸åˆ†ã®ãƒ­ã‚°ã‚’æ ¼ç´ã€‚

3. **å¤–éƒ¨å…±æœ‰ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**  
   - `events` ã®ä¸­ã® `evt.name` ãŒ "acl_change" ã¾ãŸã¯ "change_user_access" ã§ã€ã‹ã¤ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `newValue` ãŒ "outsideDomain" ã«ãªã£ã¦ã„ã‚‹ã‚‚ã®ã‚’æŠ½å‡ºã€‚

4. **ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®æ›¸ãå‡ºã—**  
   - å‰æ—¥ã®æ—¥ä»˜ã‚’ã‚·ãƒ¼ãƒˆåã«ã—ãŸã‚·ãƒ¼ãƒˆã‚’ä½œã‚Šã€æ—¢ã«ã‚ã‚Œã°å†…å®¹ã‚’åˆæœŸåŒ–ã€‚  
   - ãƒ˜ãƒƒãƒ€è¡Œã‚’è¿½åŠ ã—ã€å¤–éƒ¨å…±æœ‰ã‚¤ãƒ™ãƒ³ãƒˆ1ä»¶ã”ã¨ã«è¡Œã‚’è¿½åŠ ã€‚

5. **ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼ˆä»»æ„ï¼‰**  
   - Apps Scriptã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½¿ã„ã€æ¯æ—¥åˆå‰0æ™‚ã‚„æ—©æœãªã©ã«è‡ªå‹•å®Ÿè¡Œã•ã›ã‚‹ã¨æ—¥æ¬¡é›†è¨ˆãŒè‡ªå‹•åŒ–å¯èƒ½ã€‚

---

# æ‰€æ„Ÿ
- æ˜æ—¥ä¼šç¤¾ã®ç’°å¢ƒã§å®Ÿè£…ã—ã¦ã¿ã‚‹
- ã‚·ãƒ¼ãƒˆãŒä½œæˆã§ãã‚Œã°Slacké€£æºã™ã‚‹ãªã‚Šã€Appsheetã§å„å¾“æ¥­å“¡ã«è‡ªåˆ†ã®æ“ä½œã—ãŸå¤–éƒ¨å…±æœ‰ã‚’ãƒªã‚¹ãƒˆé…ä¿¡ã•ã›ã‚‹ãªã‚Šã®å¯¾å¿œãŒã§ããã†
- ãŸã ã—ãƒ­ã‚°ã¯ãƒ•ãƒ­ãƒ¼æƒ…å ±ãªã®ã§ã€é€šçŸ¥ã«ã¯å‘ã„ã¦ã‚‹ã‘ã©ç®¡ç†ã«ã¯å‘ã‹ãªã„
- å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–åã¨å…±æœ‰å…ˆãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå–å¾—ã§ãã‚Œã°ã€ãƒ‰ãƒ©ã‚¤ãƒ–ç®¡ç†è€…ã§å¦¥å½“æ€§åˆ¤æ–­ã™ã‚‹æƒ…å ±ã¯æä¾›ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‹ã‚‚