---
title: "ã€GASã€‘WindowsOSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨CVEæƒ…å ±ã‚’ç´ã¥ã‘ã¦ã¿ã‚‹ï¼ˆé€”ä¸­ï¼’ï¼‰"
emoji: "ğŸ¦†"
type: "idea"
topics:
  - "GAS"
published: true
published_at: "2025-03-22 20:00"
---

# ãªãœä½œæˆã—ãŸã®ã‹
- æ˜¨æ—¥macOSã§å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã‚’Windowså´ã§ã‚‚å®Ÿè£…ã—ã¦ã¿ã‚ˆã†ã¨ã„ã†è©¦ã¿ï¼ˆç¶šãï¼‰

# æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- Google Spreadsheet
- GAS
- [MSRC-Microsoft-Security-Updates-API](https://github.com/microsoft/MSRC-Microsoft-Security-Updates-API)
- [NVD CVE API](https://nvd.nist.gov/developers/vulnerabilities)

# ã‚„ã‚ŠãŸã„ã“ã¨
- MSRCã®APIã‹ã‚‰WindowsOSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã€é–¢é€£CVEç•ªå·ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹
- ç™»å ´ã™ã‚‹CVEç•ªå·ã«ã¤ã„ã¦NVDã®APIã§è©³ç´°æƒ…å ±ã‚’å–å¾—ã™ã‚‹
- Appsheetã§OSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨CVEæƒ…å ±ã‚’ç´ã¥ã‘ã¦è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

# GASï¼ˆã„ã£ãŸã‚“å‡¦ç†ã¯å®Ÿè£…ã€ä»•çµ„ã¿ä¸Šã¯å‹•ãï¼‰

- å‡¦ç†çš„ã«ã¯ä¸€é€šã‚Šå‹•ãã‘ã‚Œã©ã€GASã®å‹•ä½œæ™‚é–“ä¸Šé™6åˆ†ã‚’è¶…ãˆã¡ã‚ƒã†ã®ã§å®Ÿè³ªå½¹ã«ç«‹ãŸãªã„
- é‡è¤‡æ’é™¤ã¯è“„ç©ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¸è¦ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã™ã‚Œã°å¤šå°‘æ”¹å–„ã™ã‚‹ã‘ã‚Œã©ã€è„†å¼±æ€§æƒ…å ±ã¨OSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç´ã¥ã‘æƒ…å ±ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ã®ã¯ã©ã†ã—ãŸã‚‚ã®ã‹

```javascript
// ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’å–å¾—
const SPREADSHEET_ID = PropertiesService.getScriptProperties().getProperty('SPREADSHEET_ID');
const MSRC_API_UPDATES_URL = 'https://api.msrc.microsoft.com/cvrf/v3.0/updates/';

function main() {
  // Updateãƒªã‚¹ãƒˆã‚’å–å¾—
  const updateData = fetchMsrcUpdateData();
  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);

  updateWindowsVersionSheet(spreadsheet, updateData);

  updateWorkWinCVEsSheet(spreadsheet);
  updateCVEsSheet(spreadsheet);
}

function fetchMsrcUpdateData() {
  const response = UrlFetchApp.fetch(MSRC_API_UPDATES_URL);
  return JSON.parse(response.getContentText());
}

function updateWindowsVersionSheet(spreadsheet, data) {
  const sheet = getOrCreateSheet(spreadsheet, 'WindowsVersion');
  // ã‚·ãƒ¼ãƒˆã«ã‚¿ã‚¤ãƒˆãƒ«è¡ŒãŒãªã„å ´åˆã¯ãƒ˜ãƒƒãƒ€è¡Œã‚’è¿½åŠ 
  if(sheet.getLastRow() === 0){
    sheet.appendRow(['ID', 'Alias', 'DocumentTitle', 'Severity','InitialReleaseDate','CurrentReleaseDate', 'CvrfUrl']);
  }
  // ã‚·ãƒ¼ãƒˆã«ã‚¿ã‚¤ãƒˆãƒ«è¡ŒãŒãªã„å ´åˆã¯ãƒ˜ãƒƒãƒ€è¡Œã‚’è¿½åŠ 
  const cveSheet = getOrCreateSheet(spreadsheet, 'WindowsVersion-CVEs');
  if(cveSheet.getLastRow() === 0){
   cveSheet.appendRow(['id', 'CVE', 'ProductID']);
  }
  // ã‚·ãƒ¼ãƒˆã«ã‚¿ã‚¤ãƒˆãƒ«è¡ŒãŒãªã„å ´åˆã¯ãƒ˜ãƒƒãƒ€è¡Œã‚’è¿½åŠ 
  const productSheet = getOrCreateSheet(spreadsheet, 'WindowsProduct');
  if(productSheet.getLastRow() === 0){
    productSheet.appendRow(['ProductID', 'FullProductName']);
  }

  // æ—¢å­˜è¡Œã¨ãƒãƒƒãƒãƒ³ã‚°ã—ã€æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å ´åˆã®ã¿å‡¦ç†ã‚’è¡Œã†
  const existingRecords = new Set(sheet.getRange('A2:A' + sheet.getLastRow()).getValues().flat());

  data.value.forEach(entry => {
    const ID = entry.ID || '';
    const Alias = entry.Alias || '';
    const DocumentTitle = entry.DocumentTitle || '';
    const Severity = entry.Severity || '';
    const InitialReleaseDate = entry.InitialReleaseDate || '';
    const CurrentReleaseDate = entry.CurrentReleaseDate || '';
    const CvrfUrl = entry.CvrfUrl || '';
    
    if (!existingRecords.has(ID)) {
      sheet.appendRow([
        ID,
        Alias,
        DocumentTitle,
        Severity,
        InitialReleaseDate,
        CurrentReleaseDate,
        CvrfUrl
      ]);
      if(entry.CvrfUrl){
        const urlResponse = UrlFetchApp.fetch(entry.CvrfUrl);
        var xmlDoc = XmlService.parse(urlResponse.getContentText());
        var rootDoc = xmlDoc.getRootElement();
        // æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã®ã¿å„ç¨®ã‚·ãƒ¼ãƒˆã®è¿½åŠ ã‚’è¡Œã†
        updateWindowsProductSheet(productSheet,rootDoc)
        updateWindowsVersionCVEsSheet(cveSheet,rootDoc,entry.ID);
     }
    }
  });


}

function updateWindowsProductSheet(sheet, data) {
  // Namespaceã®å®šç¾©
  var ns = XmlService.getNamespace("prod", "http://www.icasi.org/CVRF/schema/prod/1.1");
  var products  = data.getChildren("ProductTree",ns);
  products.forEach(entry => {
    var rootBranch = entry.getChildren("Branch",ns);
    // var windowsFamilys = rootBranch.getChildren("Branch",ns);
    rootBranch.forEach(branch => {
      if (branch.getAttribute('Type').getValue() === 'Vendor' && branch.getAttribute('Name').getValue() === 'Microsoft') {
        const subBranches = branch.getChildren('Branch', ns);      
        subBranches.forEach(subBranch => {
          if (subBranch.getAttribute('Type').getValue() === 'Product Family' && subBranch.getAttribute('Name').getValue() === 'Windows') {
            const products = subBranch.getChildren('FullProductName', ns);            
            products.forEach(product => {
              const productID = product.getAttribute('ProductID').getValue();
              const productName = product.getText();
              sheet.appendRow([
                productID,
                productName
              ])
            });
          }
        });
      }
    });
  });
}

function updateWindowsVersionCVEsSheet(sheet, data, id) {
  var ns = XmlService.getNamespace("vuln", "http://www.icasi.org/CVRF/schema/vuln/1.1");
  var vulnerabilitys  = data.getChildren("Vulnerability",ns);
  vulnerabilitys.forEach(entry => {
    var cve = entry.getChildren("CVE",ns)[0].getValue();
    var productIDs = entry.getChildren("ProductStatuses",ns)[0].getChildren("Status",ns)[0].getChildren("ProductID",ns);
    productIDs.forEach(pdata => {
      sheet.appendRow([
        id,
        cve,
        pdata.getValue()
      ])
    });
  }) ;
}

function updateWorkWinCVEsSheet(spreadsheet) {
  const sheet = getOrCreateSheet(spreadsheet, 'work-WinCVEs');
  sheet.clear();
  sheet.appendRow(['CVE']);

  const cveSheet = spreadsheet.getSheetByName('WindowsVersion-CVEs');
  const uniqueCVEs = new Set(cveSheet.getRange('B2:B' + cveSheet.getLastRow()).getValues().flat());

  Array.from(uniqueCVEs).forEach(cve => sheet.appendRow([cve]));
}


function updateCVEsSheet(spreadsheet) {
  const workSheet = spreadsheet.getSheetByName('work-CVEs');
  const cveSheet = getOrCreateSheet(spreadsheet, 'CVEs');
  if(cveSheet.getLastRow() === 0){
    sheet.appendRow([
      'id',	
      'published',	
      'lastModified',	
      'vulnStatus',	
      'descriptions.value',	
      'metrics.cvssMetricV31.cvssData.VectorString',	
      'metrics.cvssMetricV31.cvssData.baseScore',	
      'metrics.cvssMetricV31.cvssData.baseSeverity',	
      'metrics.cvssMetricV31.cvssData.attackVector',	
      'metrics.cvssMetricV31.cvssData.attackComplexity',	
      'metrics.cvssMetricV31.cvssData.privilegesRequired',	
      'metrics.cvssMetricV31.cvssData.userInteraction',	
      'metrics.cvssMetricV31.cvssData.confidentiaityImpact',	
      'metrics.cvssMetricV31.cvssData.integrityImpact',	
      'metrics.cvssMetricV31.exploitabilityScore',	
      'metrics.cvssMetricV31.impactScore',	
      'metrics.cvssMetricV2.VectorString',	
      'metrics.cvssMetricV2.baseScore',
      'metrics.cvssMetricV2.accessVector',
      'metrics.cvssMetricV2.accessComplexity',
      'metrics.cvssMetricV2.authentication',	
      'metrics.cvssMetricV2.confidentiaiityImpact',
      'metrics.cvssMetricV2.integrityImpact',	
      'metrics.cvssMetricV2.availabilityImpact',	
      'metrics.cvssMetricV2.baseSeverity',	
      'metrics.cvssMetricV2.exploitabilityScore',	
      'metrics.cvssMetricV2.impactScore',	
      'metrics.cvssMetricV2.acInsurfInfo',	
      'metrics.cvssMetricV2.obtainAllPrivilege',	
      'metrics.cvssMetricV2.obtainUserPrivilege',
      'metrics.cvssMetricV2.obtainOtherPrivilege',	
      'metrics.cvssMetricV2.userInteractionRequired'
    ]);
  }

  const existingCVEs = new Set(cveSheet.getRange('A2:A').getValues().flat());
  const newCVEs = workSheet.getRange('A2:A').getValues().flat().filter(cve => !existingCVEs.has(cve));

  newCVEs.forEach(cve => {
    const response = UrlFetchApp.fetch(`${CVE_API_BASE}${cve}`);
    const cveData = JSON.parse(response.getContentText()).vulnerabilities[0].cve;

    var tcve =  cve;
    var tpublished =  cveData.published;
    var tlastModified = cveData.lastModified;
    var tvulnStatus =  cveData.vulnStatus;
    if (cveData.descriptions){ 
      var tdescription =  cveData.descriptions[0].value;
    } else { 
      var tdescription =  '';
    } 
    if (cveData.metrics.cvssMetricV31){
      var tvectorString = cveData.metrics.cvssMetricV31[0].cvssData.vectorString;
      var tbaseScore = cveData.metrics.cvssMetricV31[0].cvssData.baseScore;
      var tbaseSeverity = cveData.metrics.cvssMetricV31[0].cvssData.baseSeverity;
      var tattackVector = cveData.metrics.cvssMetricV31[0].cvssData.attackVector;
      var tattackComplexity = cveData.metrics.cvssMetricV31[0].cvssData.attackComplexity;
      var tprivilegesRequired = cveData.metrics.cvssMetricV31[0].cvssData.privilegesRequired;
      var tuserInteraction = cveData.metrics.cvssMetricV31[0].cvssData.userInteraction;
      var tconfidentialityImpact = cveData.metrics.cvssMetricV31[0].cvssData.confidentialityImpact;
      var tintegrityImpact = cveData.metrics.cvssMetricV31[0].cvssData.integrityImpact;
      var tavailabilityImpact = cveData.metrics.cvssMetricV31[0].cvssData.availabilityImpact;
      var texploitabilityScore = cveData.metrics.cvssMetricV31[0].exploitabilityScore;
      var timpactScore = cveData.metrics.cvssMetricV31[0].impactScore;
    } else {
      var tvectorString = '';
      var tbaseScore = '';
      var tbaseSeverity = '';
      var tattackVector = '';
      var tattackComplexity = '';
      var tprivilegesRequired = '';
      var tuserInteraction = '';
      var tconfidentialityImpact = '';
      var tintegrityImpact = '';
      var tavailabilityImpact = '';
      var texploitabilityScore = '';
      var timpactScore = '';
    }
    if (cveData.metrics.cvssMetricV2){
      var t2VectorString = cveData.metrics.cvssMetricV2[0].cvssData.VectorString;
      var t2baseScore = cveData.metrics.cvssMetricV2[0].cvssData.baseScore;
      var t2accessVector = cveData.metrics.cvssMetricV2[0].cvssData.accessVector;
      var t2accessComplexity = cveData.metrics.cvssMetricV2[0].cvssData.accessComplexity;
      var t2authentication = cveData.metrics.cvssMetricV2[0].cvssData.authentication;
      var t2confidentialityImpact = cveData.metrics.cvssMetricV2[0].cvssData.confidentialityImpact;
      var t2integrityImpact = cveData.metrics.cvssMetricV2[0].cvssData.integrityImpact;
      var t2availabilityImpact = cveData.metrics.cvssMetricV2[0].cvssData.availabilityImpact;
      var t2baseSeverity = cveData.metrics.cvssMetricV2[0].baseSeverity;
      var t2exploitabilityScore = cveData.metrics.cvssMetricV2[0].exploitabilityScore;
      var t2impactScore = cveData.metrics.cvssMetricV2[0].impactScore;
      var t2acInsurfInfo = cveData.metrics.cvssMetricV2[0].acInsurfInfo;
      var t2obtainAllPrivilege = cveData.metrics.cvssMetricV2[0].obtainAllPrivilege;
      var t2obtainUserPrivilege = cveData.metrics.cvssMetricV2[0].obtainUserPrivilege;
      var t2obtainOtherPrivilege = cveData.metrics.cvssMetricV2[0].obtainOtherPrivilege;
      var t2userInteractionRequired = cveData.metrics.cvssMetricV2[0].userInteractionRequired;
    } else {
      var t2VectorString = '';
      var t2baseScore = '';
      var t2accessVector = '';
      var t2accessComplexity = '';
      var t2authentication = '';
      var t2confidentialityImpact = '';
      var t2integrityImpact = '';
      var t2availabilityImpact = '';
      var t2baseSeverity = '';
      var t2exploitabilityScore = '';
      var t2impactScore = '';
      var t2acInsurfInfo = '';
      var t2obtainAllPrivilege = '';
      var t2obtainUserPrivilege = '';
      var t2obtainOtherPrivilege = '';
      var t2userInteractionRequired = '';
    }

    const row = [
      tcve,
      tpublished,
      tlastModified,
      tvulnStatus,
      tdescription,
      tvectorString,
      tbaseScore,
      tbaseSeverity,
      tattackVector,
      tattackComplexity,
      tprivilegesRequired,
      tuserInteraction,
      tconfidentialityImpact,
      tintegrityImpact,
      tavailabilityImpact,
      texploitabilityScore,
      timpactScore,
      t2VectorString,
      t2baseScore,
      t2accessVector,
      t2accessComplexity,
      t2authentication,
      t2confidentialityImpact,
      t2integrityImpact,
      t2availabilityImpact,
      t2baseSeverity,
      t2exploitabilityScore,
      t2impactScore,
      t2acInsurfInfo,
      t2obtainAllPrivilege,
      t2obtainUserPrivilege,
      t2obtainOtherPrivilege,
      t2userInteractionRequired
    ];

    cveSheet.appendRow(row);
  });
}

function getOrCreateSheet(spreadsheet, sheetName) {
  const sheet = spreadsheet.getSheetByName(sheetName);
  return sheet || spreadsheet.insertSheet(sheetName);
}

```

# æ‰€æ„Ÿ
- è¦‹ç›´ã—ã¦ã¦Productã®ã‚·ãƒ¼ãƒˆã®é‡è¤‡æ’é™¤å‡¦ç†å…¥ã‚Œã‚‹ã®å¿˜ã‚Œã¦ã‚‹ã®ã«æ°—ã¥ã
- éå»ãƒ‡ãƒ¼ã‚¿ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯å‰æã¨ã—ã¦ã€æ¯æœˆã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’ç¹°ã‚Šè¿”ã—å‡¦ç†ã§ä¿ç®¡ã—ã¦ã„ãã‚ˆã†ã«å®Ÿè£…ã‚’è€ƒãˆãªã„ã¨ã¨ã¦ã‚‚ã˜ã‚ƒãªã„ãŒä½¿ãˆãªã„
- ã¾ãŸæ°—ãŒå‘ã„ãŸã‚‰æ”¹ä¿®ã—ã‚ˆã†
