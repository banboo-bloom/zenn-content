---
title: "RSSæƒ…å ±åé›†ã‚’GASã«ç§»æ¤ã™ã‚‹"
emoji: "ğŸ¦†"
type: "idea"
topics:
  - "GAS"
published: true
published_at: "2025-05-07 12:00"
---

# ãªãœä½œæˆã—ãŸã®ã‹

- ã“ã‚Œã¾ã§ã¾ã¨ã‚ã¦ã„ãŸRSSFeedé–¢é€£å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã€ç¾è¡Œã®å‡¦ç†ã‹ã‚‰ç§»è¡Œã™ã‚‹

# å®Ÿè£…è¨˜éŒ²

## è¨­è¨ˆæ¦‚è¦

---

### RSSFeedæƒ…å ±å–å¾—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ 

```mermaid
sequenceDiagram
    autonumber
    actor Trigger  as "Time-Driven Trigger"
    participant GAS        as "collectRssFeeds()"
    participant SS         as "SpreadsheetApp\n(Active Spreadsheet)"
    participant URLs       as "`urls` Sheet"
    participant DB         as "`db` Sheet"
    participant Fetcher    as "fetchFeedText()"
    participant XmlSvc     as "XmlService"
    participant Parser     as "convertRssItem / convertAtomEntry"
    participant Log        as "Stackdriver Logs"

    Trigger ->> GAS: fires daily
    GAS ->> SS: open active spreadsheet
    GAS ->> URLs: get all feed rows
    loop each feed row
        GAS ->> Fetcher: fetchFeedText(feedUrl)
        Fetcher ->>+ Fetcher: detect charset\ngetDataAsString()
        Fetcher -->>- GAS: XML string
        GAS ->> XmlSvc: parse(XML)
        alt RSS 2.x
            GAS ->> Parser: convertRssItem(item, feedId)
        else Atom
            GAS ->> Parser: convertAtomEntry(entry, feedId)
        end
        Parser -->> GAS: [feed_id, title, timestamp, link, content, create_date]
    end

    GAS ->> DB: append new rows (batch)
    GAS ->> DB: deduplicate rows\n(by feed_id + link)
    GAS ->> Log: write summary\n(added / total / deduped)
```

---

### RSSFeedæƒ…å ±å–å¾—ã‚¯ãƒ©ã‚¹å›³

```mermaid
classDiagram
    direction LR

    %% ========== Classes ==========
    class FeedCollector {
        +collectRssFeeds()
        -existingSet:Set
        -newRows:Array
    }

    class FeedFetcher {
        +fetchFeedText(url):String
        -detectCharset(blob):String
    }

    class RssParser {
        +convertRssItem(item,id):Array
        +convertAtomEntry(entry,id):Array
        -MAX_CONTENT_LEN = 5000
        -DATE_FORMAT = "yyyy-MM-dd'T'HH:mm:ssXXX"
    }

    class SheetManager {
        +ensureDbSheet():Sheet
        +appendRows(rows)
        +deduplicate()
    }

    class FeedRecord {
        +feed_id:String
        +title:String
        +timestamp:String
        +link:String
        +content:String
        +create_date:String
    }

    %% ========== Relationships ==========
    FeedCollector "1" --> "1" SheetManager : uses
    FeedCollector "1" --> "1" FeedFetcher  : uses
    FeedCollector "1" --> "1" RssParser    : uses
    RssParser     ..> FeedRecord           : Â«returnsÂ»
    SheetManager  ..> FeedRecord           : Â«storesÂ»
```




---

## æ³•äººç•ªå·æƒ…å ±ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ â€” ç™»éŒ²ãƒ»ãƒãƒƒãƒæ›´æ–°ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    autonumber
    participant Admin as æƒ…ã‚·ã‚¹æ‹…å½“è€…<br/>(AppSheet)
    participant SS as Google Spreadsheet
    participant GAS as Apps Script
    participant gBiz as gBizINFO API

    %% --- æ‰‹å‹•ç™»éŒ²ãƒ•ãƒ­ãƒ¼ ---------------------------------
    Admin->>SS: Stakeholders ã‚·ãƒ¼ãƒˆã«<br/>hojinBango ç™»éŒ²/æ›´æ–°
    SS-->>GAS: onEdit(e) ãƒˆãƒªã‚¬ãƒ¼
    alt hojinBango ç©º
        GAS-->>SS: ä½•ã‚‚ã—ãªã„
    else
        GAS->>gBiz: å…¨ 7 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå‘¼ã³å‡ºã—<br/>(finance, patent â€¦)
        gBiz-->>GAS: JSON é…åˆ—
        loop å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
            GAS->>SS: å­ã‚·ãƒ¼ãƒˆã¸ upsert<br/>(idx ä»˜ãè¤‡æ•°è¡Œ)
        end
        GAS->>gBiz: æ³•äººåŸºæœ¬æƒ…å ± (æœ€å¾Œ)
        gBiz-->>GAS: JSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        GAS->>SS: BasicInfo ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆ (1 è¡Œ)
        GAS-->>Admin: å®Œäº†ãƒ¡ãƒ¼ãƒ«
    end

    %% --- å®šæœŸãƒãƒƒãƒãƒ•ãƒ­ãƒ¼ ---------------------------------
    note over GAS: cronFetchAll (03:00 æ¯æ—¥)
    GAS->>SS: Stakeholders & BasicInfo å–å¾—
    loop for each stakeholder
        alt BasicInfo æœªå–å¾—
            GAS->>gBiz: å…¨ 7 + BasicInfo å–å¾—
            gBiz-->>GAS: å„é…åˆ—
            loop ep in ENDPOINTS
                GAS->>SS: å­ã‚·ãƒ¼ãƒˆ upsert
            end
            GAS->>SS: BasicInfo upsert (æœ€å¾Œ)
        else BasicInfo æ—¢å–å¾—
            GAS-->>GAS: skip
        end
        alt æ®‹ã‚Šå®Ÿè¡Œæ™‚é–“ < 30s
            GAS-->>GAS: safety break (æ¬¡å›ç¶šè¡Œ)
            break
        end
    end

```

---

## æ³•äººç•ªå·æƒ…å ±ã‚¯ãƒ©ã‚¹å›³ â€” ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ§‹é€ 

```mermaid
classDiagram
    class Stakeholders {
        string id PK
        string name
        string description
        string url
        string image
        string file
        string hojinBango
    }

    class BasicInfo {
        string corporate_number PK
        string name
        string name_kana
        string post_code
        string address
        string close_date
        string update_date
        number capital_stock_amount
        number employees
        string industry
        --- meta ---
        string stakeholderId FK
        datetime fetchedAt
    }

    %% idx ä»˜ãå­ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆè¤‡åˆ PKï¼‰
    class Certification {
        int    idx PK
        string corporate_number PK
        string certification_type
        date   certification_date
        string certification_no
        string issuer
        --- meta ---
        string stakeholderId FK
        datetime fetchedAt
    }

    class Commendation {
        int    idx PK
        string corporate_number PK
        string award_name
        date   award_date
        string issuer
        --- meta ---
        string stakeholderId FK
        datetime fetchedAt
    }

    class Finance {
        int    idx PK
        string corporate_number PK
        int    fiscal_year
        number sales
        number profit
        number assets
        number equity
        --- meta ---
        string stakeholderId FK
        datetime fetchedAt
    }

    class Patent {
        int    idx PK
        string corporate_number PK
        string patent_no
        string title
        date   filing_date
        string status
        --- meta ---
        string stakeholderId FK
        datetime fetchedAt
    }

    class Procurement {
        int    idx PK
        string corporate_number PK
        string agency
        string subject
        number amount
        date   publish_date
        --- meta ---
        string stakeholderId FK
        datetime fetchedAt
    }

    class Subsidy {
        int    idx PK
        string corporate_number PK
        string program
        string phase
        number amount
        date   adopt_date
        --- meta ---
        string stakeholderId FK
        datetime fetchedAt
    }

    class Workplace {
        int    idx PK
        string corporate_number PK
        number avg_continuous_years
        number avg_age
        number avg_overtime_hours
        number ratio_female
        --- meta ---
        string stakeholderId FK
        datetime fetchedAt
    }

    %% ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    Stakeholders "1" o-- "0..*" BasicInfo
    Stakeholders "1" o-- "0..*" Certification
    Stakeholders "1" o-- "0..*" Commendation
    Stakeholders "1" o-- "0..*" Finance
    Stakeholders "1" o-- "0..*" Patent
    Stakeholders "1" o-- "0..*" Procurement
    Stakeholders "1" o-- "0..*" Subsidy
    Stakeholders "1" o-- "0..*" Workplace
```

## Appsheet

### å–å¾—ã—ãŸRSSFeedæƒ…å ±
![](/images/2025050700001/2025050701.png)

### å–å¾—ã—ãŸæ³•äººæƒ…å ±ã®ä½æ‰€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã—ãŸç”»é¢
![](/images/2025050700001/2025050701.png)

# æ‰€æ„Ÿ
- ä¸€æ—¦å‡¦ç†ã¯å›ã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã—ã°ã‚‰ãé‹ç”¨ã—ã¦ã¿ã‚‹
- ã§ãã‚Œã°Difyã¨APIé€£æºã—ã¦æ¯æ—¥ã®ã‚µãƒãƒªæƒ…å ±ã‚’ãƒ¬ãƒãƒ¼ãƒˆé€šçŸ¥ã—ãŸã„
- ã¤ã„ã§ã«æƒ…å ±ã®ä»•åˆ†ã‘ã‚‚ã‚ã‚“ã©ãã•ã„ã‹ã‚‰åˆ†é¡è‡ªå‹•åŒ–â†’å„ªå…ˆåº¦é«˜ã„æƒ…å ±ã‚’ãƒ¬ãƒãƒ¼ãƒˆæŠ½å‡ºã«ã™ã‚‹ã®ãŒç†æƒ³çš„ã‹ãªã‚