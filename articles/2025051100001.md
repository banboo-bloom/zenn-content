---
title: "ã€GASã€‘ã‚¿ã‚°ã®è§£èª¬æƒ…å ±ä½œæˆã‚’è‡ªå‹•åŒ–ã—ãŸã„"
emoji: "ğŸ¦†"
type: "idea"
topics:
  - "GAS"
published: true
published_at: "2025-05-11 12:00"
---

# ãªãœä½œæˆã—ãŸã®ã‹

- æƒ…å ±åˆ†é¡ã®ãŸã‚ã«ã‚¿ã‚°ä»˜ã‘ã—ã¦æƒ…å ±ã‚¹ãƒˆãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã«ã—ãŸã‚‰ã‚¿ã‚°ãŒç„¡é™å¢—æ®–ã‚’ã¯ã˜ã‚ãŸã®ã§ã€è§£èª¬æ–‡ã‚’ã‚¤ãƒã‚¤ãƒã¾ã¨ã‚ã‚‹ã®ãŒé¢å€’ã«ãªã£ã¦ããŸã®ã§ã€ã‚¿ã‚°ã¨è¦ªã‚¿ã‚°ã‹ã‚‰è§£èª¬æ–‡ã‚’Geminiãã‚“ã«ä½œã£ã¦ã‚‚ã‚‰ãŠã†ã¨ã„ã†è©¦ã¿

# ã‚„ã‚ŠãŸã„ã“ã¨
- ã‚¿ã‚°åç§°ã«å¯¾ã—ã¦ã€è§£èª¬æ–‡æœªè¨­å®šã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ã€ITä¼æ¥­ã®æƒ…ã‚·ã‚¹æ‹…å½“è€…ãŒæŠ‘ãˆã¦ãŠãã¹ãè§£èª¬æ–‡ç« ã‚’è‡ªå‹•ä½œæˆã™ã‚‹

# æ—¢å­˜ã®ç’°å¢ƒ
## ã‚·ãƒ¼ãƒˆã€Œdbã€
|column|description|
|---|---|
|feed_id|RSSFeedå–å¾—å…ƒæƒ…å ±æºã‚’ç¤ºã™IDï¼ˆåˆ¥ã‚·ãƒ¼ãƒˆã®ãƒ—ãƒ©ã‚¤ãƒãƒªKeyï¼‰
|title|RSSFeedã§å–å¾—ã—ãŸè¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«
|timestamp|RSSFeedã‹ã‚‰å–å¾—ã—ãŸå…¬é–‹æ—¥
|link|RSSFeedã‹ã‚‰å–å¾—ã—ãŸè¨˜äº‹URL
|content|RSSFeedã‹ã‚‰å–å¾—ã—ãŸè¨˜äº‹æ¦‚è¦
|create_date|å–å¾—å‡¦ç†ã‚’å®Ÿè¡Œã—ãŸæ—¥
|exclude|è¡¨ç¤ºé™¤å¤–ãƒ•ãƒ©ã‚°
|bookmark|ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ•ãƒ©ã‚°

## ã‚·ãƒ¼ãƒˆã€Œtagsã€
|column|description|
|---|---|
|id|ã‚¿ã‚°ã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹ID
|tag|ã‚¿ã‚°æ–‡å­—åˆ—
|description|ã‚¿ã‚°ã®è§£èª¬æ–‡
|parent-tag|è¦ªå­é–¢ä¿‚ã«ã‚ã‚‹è¦ªã‚¿ã‚°ã®IDï¼ˆåŒä¸€ã‚·ãƒ¼ãƒˆå†…IDã‚’å‚ç…§ï¼‰

## ã‚·ãƒ¼ãƒˆã€ŒtagRelationsã€
|column|description|
|---|---|
|id|ã‚¿ã‚°ã¨è¨˜äº‹ã®é–¢é€£æ€§ã‚’è­˜åˆ¥ã™ã‚‹ä¸€æ„ã®ID
|tag|tagsã®idã‚’å‚ç…§
|db|dbã®linkã‚’å‚ç…§

## å‡¦ç†ã¨ã—ã¦ã‚„ã‚ŠãŸã„ã“ã¨ã®è¨˜è¿°
- **å‡¦ç†å¯¾è±¡ã¨ã™ã‚‹ã‚¹ã‚³ãƒ¼ãƒ—**
  - ã‚·ãƒ¼ãƒˆã€Œtagsã€ã®ã†ã¡ã€descriptionã«å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãƒ¬ã‚³ãƒ¼ãƒ‰

- **å‡¦ç†æ¦‚è¦**
  - å‡¦ç†ã¯GASã§å®Ÿè£…ã™ã‚‹
  - å¯¾è±¡ãƒ¬ã‚³ãƒ¼ãƒ‰ã®tagã€è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ–‡è„ˆã®æ–¹å‘ä»˜ã‘ã¨ã—ã¦parent-tagã®æ–‡å­—åˆ—ã‚’åŸºã«ã€tagã«å¯¾ã™ã‚‹è§£èª¬æ–‡ã‚’ç”Ÿæˆã—ã¦ã€descriptionã«ã‚»ãƒƒãƒˆã™ã‚‹ã€‚
    - è§£èª¬æ–‡ã®ç”Ÿæˆã«ã¯ gemini-2.0-flash APIã‚’ä½¿ç”¨ã™ã‚‹
  - å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ã‚ˆã‚Šä¸­æ–­ã•ã‚Œã‚‹ã“ã¨ã‚’è€ƒæ…®ã—ã€ç¹°ã‚Šè¿”ã—å®Ÿè¡Œã«è€ãˆã‚‰ã‚Œã‚‹ã‚ˆã†å‡¦ç†ã®ä¸€è²«æ€§ã‚’æ‹…ä¿ã™ã‚‹


# GAS

```javascript

/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *   tags.description ãŒç©ºã®è¡Œã« Gemini ã§è§£èª¬æ–‡ã‚’ç”Ÿæˆã—ã¦å…¥åŠ›
 *   - Google AI Gemini 2.0 Flash ã‚’ REST API çµŒç”±ã§å‘¼ã³å‡ºã—
 *   - 1 å®Ÿè¡Œã‚ãŸã‚Š GM_BATCH_SIZE è¡Œã ã‘å‡¦ç†ã—ã¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å›é¿
 *   - å‡¦ç†é€²æ—ã¯ ScriptProperties ã«ä¿å­˜ï¼ˆidempotentï¼‰
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */
const SHEET_TAGS        = 'tags';
const API_KEY_PROP      = 'GEMINI_API_KEY';       // ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å
const PROGRESS_PROP     = 'tagdesc_last_row';
const MODEL_URL         = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
const GM_BATCH_SIZE        = 15;                     // 1 å®Ÿè¡Œã§å‡¦ç†ã™ã‚‹è¡Œæ•°
const GM_TIMEOUT_MS        = 20 * 1000;              // 1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆæœ€å¤§å¾…æ©Ÿ 20 ç§’

/**
 * ãƒ¡ã‚¤ãƒ³ãƒˆãƒªã‚¬ãƒ¼
 */
function fillTagDescriptions() {
  const ss       = SpreadsheetApp.getActiveSpreadsheet();
  const tagSh    = ss.getSheetByName(SHEET_TAGS);
  if (!tagSh) throw new Error(`ã‚·ãƒ¼ãƒˆã€Œ${SHEET_TAGS}ã€ãŒã‚ã‚Šã¾ã›ã‚“`);

  const apiKey = PropertiesService.getScriptProperties().getProperty(API_KEY_PROP);
  if (!apiKey) throw new Error(`ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€Œ${API_KEY_PROP}ã€ã« Gemini API ã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„`);

  // --- ã‚·ãƒ¼ãƒˆå…¨è¡Œèª­ã¿å‡ºã— ---
  const data      = tagSh.getDataRange().getValues();  // 0:ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
  const header    = data.shift();
  const COL_ID    = header.indexOf('id');
  const COL_TAG   = header.indexOf('tag');
  const COL_DESC  = header.indexOf('description');
  const COL_PARENT= header.indexOf('parent-tag');

  // --- parent-tag ç”¨ãƒãƒƒãƒ—ä½œæˆï¼ˆid â†’ tag æ–‡å­—åˆ—ï¼‰---
  const id2tag = new Map(data.map(r => [String(r[COL_ID]), String(r[COL_TAG])]));

  // --- é€²æ—èª­ã¿è¾¼ã¿ ---
  const prop      = PropertiesService.getScriptProperties();
  let   startRow  = Math.max(Number(prop.getProperty(PROGRESS_PROP) || 2), 2); // 2 è¡Œç›®ã‹ã‚‰
  if (startRow > data.length + 1) startRow = 2;                                // çµ‚äº†ã—ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
  const endRow    = Math.min(startRow + GM_BATCH_SIZE - 1, data.length + 1);

  const updates = [];   // {row, text}

  for (let i = startRow; i <= endRow; i++) {
    const idx   = i - 2;                // data é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    const row   = data[idx];
    if (row[COL_DESC]) continue;        // æ—¢ã«èª¬æ˜ã‚ã‚Š

    const tagStr      = String(row[COL_TAG]);
    const parentId    = String(row[COL_PARENT] || '');
    const parentName  = id2tag.get(parentId) || '';

    try {
      const prompt = buildPrompt(tagStr, parentName);
      const desc   = callGemini(apiKey, prompt);
      if (desc) updates.push({row: i, text: desc});
    } catch (e) {
      console.error(`Gemini ç”Ÿæˆå¤±æ•— (row ${i}): ${e}`);
    }
  }

  // --- ã‚·ãƒ¼ãƒˆæ›´æ–°ï¼ˆã¾ã¨ã‚ã¦ setValueï¼‰---
  for (const {row, text} of updates) {
    tagSh.getRange(row, COL_DESC + 1).setValue(text);
  }

  // --- é€²æ—ä¿å­˜ ---
  const nextStart = (endRow >= data.length + 1) ? 2 : endRow + 1;
  prop.setProperty(PROGRESS_PROP, String(nextStart));

  console.log(`Rows ${startRow}-${endRow} ã‚’ãƒã‚§ãƒƒã‚¯ã€‚ç”Ÿæˆ ${updates.length} è¡Œã€‚æ¬¡å›é–‹å§‹è¡Œ: ${nextStart}`);
}

/**
 * è§£èª¬æ–‡ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
 * - IT ä¼æ¥­ã®æƒ…ã‚·ã‚¹æ‹…å½“è€…ãŒèª­è€…
 * - 2ã€œ3 æ–‡ã§ç°¡æ½”ã«
 */
function buildPrompt(tag, parent) {
  const parentPart = parent ? `ï¼ˆä¸Šä½æ¦‚å¿µ: ${parent}ï¼‰` : '';
  return `ã‚ãªãŸã¯ IT ä¼æ¥­ã®æƒ…ã‚·ã‚¹æ‹…å½“è€…å‘ã‘ã«ã€æŠ€è¡“ç”¨èªã‚’ç°¡æ½”ã«èª¬æ˜ã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚
æ¬¡ã®ã‚¿ã‚°ã«å¯¾ã—ã¦ 2ã€œ3 æ–‡ã®æ—¥æœ¬èªè§£èª¬ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚å°‚é–€ç”¨èªã¯ã‹ã¿ç •ãã€è¦ç‚¹ã®ã¿ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚ã‚¿ã‚¤ãƒˆãƒ«ã‚„å‰ç½®ãã‚’å«ã‚ãšã€è§£èª¬æ–‡ã®ã¿ã‚’å›ç­”ã—ã¦ãã ã•ã„ã€‚
ã‚¿ã‚°: ã€Œ${tag}ã€${parentPart}`;
}

/**
 * Gemini 2.0 Flash API å‘¼ã³å‡ºã—
 * è¿”å€¤: ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆ or ''ï¼ˆå¤±æ•—æ™‚ï¼‰
 */
function callGemini(apiKey, prompt) {
  const payload = {
    contents: [{parts: [{text: prompt}]}],
    generationConfig: {maxOutputTokens: 120, temperature: 0.3}
  };
  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true,
    followRedirects: true,
    escaping: false,
    deadline: GM_TIMEOUT_MS / 1000
  };
  const url   = `${MODEL_URL}?key=${encodeURIComponent(apiKey)}`;
  const resp  = UrlFetchApp.fetch(url, options);
  const code  = resp.getResponseCode();
  if (code !== 200) throw new Error(`Gemini API error ${code}: ${resp.getContentText()}`);

  const json  = JSON.parse(resp.getContentText());
  return json?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';
}

```

# æ‰€æ„Ÿ
- å‡¦ç†ã¯10ç§’ãã‚‰ã„ã§å®Œäº†ã—ã¦ã‚‹ã®ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ä»Šã®ã¨ã“ã‚å¤§ä¸ˆå¤«ãã†
- åˆæœŸãƒ‡ãƒ¼ã‚¿ã¯ã²ã¨ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ããŸã‘ã‚Œã©ã€å†…éƒ¨ã®é€²æ—å¤‰æ•°ã‚‚å…ˆé ­ã«æˆ»ã‚‹
- ã“ã®å‡¦ç†ã‚’ã©ã®ã‚ˆã†ãªé »åº¦ã§èµ·å‹•ã™ã‚‹ã‹ï¼Ÿ
- ã‚¿ã‚°ã¯è‡ªå‹•ç”Ÿæˆã§ã¯ãªãæ‰‹å‹•è¿½åŠ ã ã—ã€è¡Œè¿½åŠ ãƒˆãƒªã‚¬ãƒ¼ã§èµ·å‹•ã—ã¤ã¤ã€æƒ…å ±æ›´æ–°ã‚’æ„è­˜ã—ã¦æ¯æ™‚ãƒˆãƒªã‚¬ãƒ¼ã‚’ä»•è¾¼ã‚“ã§ãŠãã‹ãªã‚

![](/images/2025051100001/2025051101.png)